!function(t){t.widget("marcotaubmann.snippeter",{options:{snippets:[],activator:"#",caretTag:"[caret]",excludeSign:"-",selectedClass:"ui-state-focus",nonselectedClass:"ui-menu-item",highlightClass:"ui-state-highlight",snippetClass:"ui-snippeter-snippet",keywordsClass:"ui-snippeter-snippet-keywords ui-state-disabled",valueClass:"ui-snippeter-snippet-value",listElement:null},_setOption:function(e,s){"listElement"===e&&(null===s&&(s=t("<div></div>").addClass("ui-menu ui-widget ui-widget-content ui-helper-clearfix ui-snippeter-list"),this.element.after(s)),this.list=t(s)),this._super(e,s)},_create:function(){var e=this;this._setOption("listElement",this.options.listElement),this.element.on("keydown",function(t){e._keydown(t)}),this.element.on("keyup click focusin",function(t){[9,13,27,38,40].indexOf(t.keyCode)<=-1&&e._refresh()}),t(document).on("click",function(s){s.target===e.list[0]||t.contains(e.list[0],s.target)||s.target===e.element[0]||e._clearList()}),this._refresh()},_keydown:function(t){if(9===t.keyCode)return void this._clearList();var e=this.element.val(),s=this.element.caret(),i=e.substring(0,s).lastIndexOf(this.options.activator);i>=0&&(13===t.keyCode?(t.preventDefault(),this._insertSelected()):27===t.keyCode?(this._deactivate(),this._refresh()):38===t.keyCode?(t.preventDefault(),this._selectionUp()):40===t.keyCode&&(t.preventDefault(),this._selectionDown()))},_selectFirst:function(){this.list.children("."+this.options.selectedClass).removeClass(this.options.selectedClass),this.list.children().first().addClass(this.options.selectedClass).trigger("select")},_selectLast:function(){this.list.children("."+this.options.selectedClass).removeClass(this.options.selectedClass),this.list.children().last().addClass(this.options.selectedClass).trigger("select")},_selectionUp:function(){var t=this.list.children("."+this.options.selectedClass);t.removeClass(this.options.selectedClass),t.prev().length?t.prev().addClass(this.options.selectedClass).trigger("select"):this._selectLast()},_selectionDown:function(){var t=this.list.children("."+this.options.selectedClass);t.removeClass(this.options.selectedClass),t.next().length?t.next().addClass(this.options.selectedClass).trigger("select"):this._selectFirst()},_insertSelected:function(){this.list.children("."+this.options.selectedClass).trigger("insert")},_deactivate:function(){var t=this.element.val(),e=this.element.caret(),s=t.substring(0,e).lastIndexOf(this.options.activator);this.element.val(t.substring(0,s)+t.substring(e)),this.element.caret(s)},_refresh:function(){var e=this.element.val(),s=this.element.caret(),i=e.substring(0,s).lastIndexOf(this.options.activator);if(i>=0){var n=t.trim(e.substring(i+this.options.activator.length,s)),l=this._searchSnippets(n);this._updateList(l,n)}else this._clearList()},_searchSnippets:function(t){if(""===t)return this.options.snippets;var e=this,s=this.options.snippets.filter(function(s){return e._snippetMatchesSearchText(s,t)});return s},_clearList:function(){this._updateList(null,null)},_updateList:function(e,s){if(this.list.hide(),this.list.empty(),e&&e.length){var i=this;e.forEach(function(e){var n={keywords:i._highlight(i._snippetKeywords(e),s),value:i._highlight(i._snippetValue(e),s)},l=i._snippetToHtml(n),r=t(l).addClass(i.options.nonselectedClass);r.on("click insert",function(){i._insert(e),i._refresh()}),r.appendTo(i.list)}),this._selectFirst(),this.list.show(),this.list.css("width",this.element.width()),this.list.position({my:"left bottom",at:"left top",of:this.element})}this.list.trigger("update")},_snippetMatchesSearchText:function(t,e){var s,i=e.split(" ");for(s=0;s<i.length;s++){var n=i[s];if(!this._snippetMatchesWord(t,n))return!1}return!0},_snippetMatchesWord:function(e,s){var i=!0;if(s.charAt(0)===this.options.excludeSign&&(s=s.substring(1),i=!1)," "===s||""===s)return!0;var n=new RegExp("("+s+")","gi");return wordContained=t.isArray(this._snippetKeywords(e).match(n))||t.isArray(this._snippetValue(e).replace(this.options.caret,"").match(n)),i===wordContained},_snippetToHtml:function(t){return'<div class="'+this.options.snippetClass+'"><div class="'+this.options.keywordsClass+'">'+this._snippetKeywords(t)+'</div><div class="'+this.options.valueClass+'">'+this._snippetValue(t).replace(this.options.caretTag,"")+"</div></div>"},_highlight:function(t,e){if(""===e)return t;var s,i=e.split(" ");for(s=0;s<i.length;s++){var n=i[s];if(n.charAt(0)!==this.options.excludeSign){var l=new RegExp("("+n+")","gi");t=t.replace(l,'<span class="'+this.options.highlightClass+'">$1</span>')}}return t},_insert:function(t){var e=this.element.val(),s=this.element.caret(),i=e.substring(0,s).lastIndexOf(this.options.activator),n=this._snippetValue(t);this.element.val(e.substring(0,i)+n+e.substring(s)),this.element.caret(i+n.length);var l=this.element.val().substring(0,this.element.caret()).lastIndexOf(this.options.caretTag);l>=0&&(this.element.val(this.element.val().replace(this.options.caretTag,"")),this.element.caret(l))},_snippetKeywords:function(t){return"object"==typeof t?t.keywords:""},_snippetValue:function(t){return"object"==typeof t?t.value:t}})}(jQuery);